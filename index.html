
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">

		<title>gun test</title>

		<script src="https://rawgit.com/amark/gun/master/gun.js"></script>

		<script type="text/javascript" src="https://rawgit.com/cpettitt/dagre/master/dist/dagre.min.js"></script>
		<script type="text/javascript" src="graph.js"></script>
	</head>
	
	<body>
	<script>
/*
fire my server thingie

ssh stage.sl.pt
cd Work/gun_test
node run.js

https://github.com/amark/gun/wiki
*/

var log = function() { window.console.log.apply(window.console, arguments); };

var log2 = function(txt) { return log(txt); };

//localStorage.clear();

//var gun = window.Gun('http://stage.sl.pt:1337/');
var gun = window.Gun();

/*gun
	.set({ name:'Helen', species:'human' })
	.key('person/h')

	//.load('person/h')

	.path('cat')

	.set({ name:'Cesar', species:'cat' })
	.key('cat/c');*/

/*
gun
	.load('person/h')
	.get(function(h) {
		this
			.load('cat/c')
			.path('person')
			.set(h);
	})
	.blank(log2('oops'));
*/

// gun.set({age:10}).set({gender:'m'}).key('a')
// gun.set({age:10}).set({gender:'m'}).key('b')
// gun.load('a').get(function(a) { gun.load('b').path('cena').set(a); }) // b - cena -> a
// gun.load('b').get(function(b) { gun.load('a').path('cena2').set(b); }) // a - cena2 -> b
// drawGraph()


//gun.load('person/h').get(log).path('cat').get(log).path('person').get(log);

// gun.__.keys
// gun.__.graph


var forKV = function(o, cb) {
	for (var k in o) {
		if (!o.hasOwnProperty(k)) { continue; }
		cb(k, o[k]);
	}
};

var rndId = function() {
	return 'rnd' + ~~( Math.random() * 1000000 );
};


var c;

var drawGraph = function() {
	if (c) {
		document.body.removeChild(c);
	}

	var nodes = [];
	var edges = [];

	//gun.__.keys;

	forKV(gun.__.graph, function(id, n) {
		nodes.push({
			id: id,
			label: id.substring(0, 6),
			//label: id,
			backgroundColor: '#FCC'
		});

		forKV(n, function(k2, val) {
			var id2 = rndId();

			if (typeof val === 'object') {
				if (k2 === '_') { return; }

				return edges.push({
					from: id,
					to:   val['#'],
					label: k2,
					lineWidth: 2,
					lineColor: '#F0F'
				});
			}

			nodes.push({
				id: id2,
				label: '' + val,
				backgroundColor: '#CCC'
			});

			edges.push({
				from: id,
				to:   id2,
				label: k2,
				lineWidth: 2,
				lineColor: '#000'
			});
		});
	});

	forKV(gun.__.keys, function(index, o) {
		nodes.push({
			id: index,
			label: index,
			backgroundColor: '#CFC'
		});

		edges.push({
			from: index,
			to:   o._['#']
		});

		//console.log(index, o._['#']);
	});

	c = graph({
		nodes: nodes,
		edges: edges
	});

	document.body.appendChild(c);
}

//setTimeout(drawGraph, 1000);

</script>
</body>
</html>